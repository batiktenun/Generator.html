<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mockup Generator - Displacement FIXED</title>
<style>
body{
  font-family:system-ui;
  display:flex;
  gap:20px;
  padding:20px;
  background:#f6f7fb;
}

.panel{
  width:360px;
  background:white;
  padding:16px;
  border-radius:12px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.preview-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:12px;
}

.preview{
  background:white;
  padding:12px;
  border-radius:12px;
  display:flex;
  justify-content:center;
}

canvas{
  max-width:100%;
  background:white;
  border-radius:8px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

label{
  margin-top:12px;
  display:block;
  font-size:14px;
}

.row{
  display:flex;
  align-items:center;
  gap:6px;
}

button{
  padding:10px 14px;
  border-radius:8px;
  border:0;
  background:#0b66ff;
  color:white;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="panel">
  <h3>Mockup Generator (Fixed Displacement)</h3>

  <label>Upload Foto Baju</label>
  <input id="shirtFile" type="file" accept="image/*">

  <label>Upload Motif</label>
  <input id="patternFile" type="file" accept="image/*">

  <label>Displacement Strength</label>
  <input id="strength" type="range" min="0" max="100" value="20">

  <label>Opacity Motif</label>
  <input id="opacity" type="range" min="0" max="1" step="0.01" value="1">

  <button id="downloadBtn">Download PNG</button>
</div>

<div class="preview-wrap">
  <div class="preview">
    <canvas id="canvas" width="900" height="1100"></canvas>
  </div>
  <img id="preview" style="width:200px;border:1px solid #ddd;border-radius:8px;background:white">
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let shirtImg = null;
let patternImg = null;
let lumMap = null;

// ====== LOAD FILES ======

document.getElementById('shirtFile').addEventListener('change', e=>{
  loadFile(e.target.files[0], img=>{
    shirtImg = img;
    computeLumMap();
    draw();
  });
});

document.getElementById('patternFile').addEventListener('change', e=>{
  loadFile(e.target.files[0], img=>{
    patternImg = img;
    draw();
  });
});

document.getElementById('strength').addEventListener('input', draw);
document.getElementById('opacity').addEventListener('input', draw);

function loadFile(file, cb){
  const r = new FileReader();
  r.onload = e=>{
    const img = new Image();
    img.onload = ()=>cb(img);
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}

// ====== LUMINANCE MAP ======

function computeLumMap(){
  if(!shirtImg) return;
  const w = canvas.width, h = canvas.height;

  const t = document.createElement('canvas');
  t.width = w; t.height = h;

  const tctx = t.getContext('2d');
  tctx.drawImage(shirtImg, 0, 0, w, h);

  const data = tctx.getImageData(0, 0, w, h).data;
  lumMap = new Float32Array(w*h);

  for(let i=0, j=0; i<data.length; i+=4, j++){
    lumMap[j] = (0.2126*data[i] + 0.7152*data[i+1] + 0.0722*data[i+2]) / 255;
  }
}

// ====== MAIN DRAW ======

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(shirtImg){
    ctx.drawImage(shirtImg,0,0,canvas.width,canvas.height);
  }

  if(!patternImg) return;

  // STEP 1: Render motif ke patternCanvas
  const pw = canvas.width, ph = canvas.height;
  const pCan = document.createElement('canvas');
  pCan.width = pw;
  pCan.height = ph;
  const pctx = pCan.getContext('2d');

  // Motif ditaruh di tengah area baju
  pctx.drawImage(patternImg, pw*0.2, ph*0.2, pw*0.6, ph*0.6);

  // STEP 2: Displacement â†’ di canvas terpisah
  const displaced = document.createElement('canvas');
  displaced.width = pw;
  displaced.height = ph;
  const dctx = displaced.getContext('2d');

  if(lumMap){
    const strength = Number(document.getElementById('strength').value);
    const pData = pctx.getImageData(0,0,pw,ph).data;

    const out = dctx.createImageData(pw,ph);
    const outData = out.data;

    for(let y=0; y<ph; y++){
      for(let x=0; x<pw; x++){
        const i = y*pw + x;
        const lum = lumMap[i];

        // displacement offset
        const dx = (lum - 0.5) * strength;
        const dy = (lum - 0.5) * strength;

        let sx = Math.round(x + dx);
        let sy = Math.round(y + dy);

        // clamp
        if(sx<0) sx=0;
        if(sx>=pw) sx=pw-1;
        if(sy<0) sy=0;
        if(sy>=ph) sy=ph-1;

        const si = (sy*pw + sx)*4;
        const oi = i*4;

        outData[oi]   = pData[si];
        outData[oi+1] = pData[si+1];
        outData[oi+2] = pData[si+2];
        outData[oi+3] = pData[si+3];
      }
    }

    dctx.putImageData(out,0,0);
  } else {
    dctx.drawImage(pCan,0,0);
  }

  // STEP 3: Blend motif displaced ke atas baju
  ctx.globalAlpha = Number(document.getElementById('opacity').value);
  ctx.globalCompositeOperation = "multiply"; // efek kain
  ctx.drawImage(displaced, 0, 0);
  ctx.globalAlpha = 1;
  ctx.globalCompositeOperation = "source-over";

  // Update preview kecil
  document.getElementById('preview').src = canvas.toDataURL();
}

// ====== DOWNLOAD ======

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  const link = document.createElement('a');
  link.download = "mockup.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});
</script>

</body>
</html>