<!-- PART 1 / 5 START -->
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mockup Maker + AI Brush</title>

<style>
:root{--accent:#0b66ff;--danger:#e53e3e;--accent-2:#f39c12}
*{box-sizing:border-box}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:14px;background:#f6f7fb;color:#0b0b0b;display:flex;gap:14px}
.panel{width:420px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(20,20,40,.08);padding:14px}
.preview-wrap{flex:1;display:flex;flex-direction:column;gap:12px}
.preview{display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#fff,#fafafa);padding:12px;border-radius:12px}
canvas{background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06);max-width:100%;height:auto;touch-action:none}
input[type="range"]{width:100%}
label{display:block;margin-top:8px;font-size:13px;color:#444}
.row{display:flex;gap:8px;align-items:center;margin-top:8px}
.controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
.step{background:#e6eefc;border:1px solid #d0e4ff;color:#0b66ff;padding:6px 8px;border-radius:6px;cursor:pointer}
.badge{background:#f1f5f9;padding:6px 8px;border-radius:8px;font-size:12px;display:flex;gap:6px;align-items:center}
.small{font-size:12px;color:#666}
.hint{font-size:13px;color:#444}
.mt-indicator{position:fixed;right:18px;bottom:18px;background:#111;color:#fff;padding:8px 10px;border-radius:10px;opacity:0;transition:opacity .18s;font-size:13px}
.accent{background:var(--accent-2)}
.danger{background:var(--danger)}
.neutral{background:#eee;color:#111}
.preview-wrap .thumbs{display:flex;gap:12px}
.preview-wrap img{width:180px;border-radius:8px;border:1px solid #eee;background:#fff;margin-top:6px}
fieldset{border:1px solid #eef2ff;padding:8px;border-radius:8px;margin-top:10px}
legend{font-size:13px;padding:0 6px}
.lab{width:56px;display:inline-block}
</style>
</head>
<!-- PART 1 / 5 END -->
<!-- PART 2 / 5 START -->
<body>

<div class="panel">
    <h2>Mockup Maker + AI Brush</h2>

    <!-- Upload gambar baju -->
    <label><b>Upload Gambar Baju</b>
        <input type="file" id="shirtInput" accept="image/*">
    </label>

    <!-- Upload motif -->
    <label><b>Upload Desain Motif</b>
        <input type="file" id="patternInput" accept="image/*">
    </label>

    <!-- Upload mask baju (PNG transparan) -->
    <label><b>Upload Mask Baju (PNG Transparan)</b>
        <input type="file" id="maskInput" accept="image/*">
    </label>

    <hr>

    <h3>ðŸŽ› Tuning Posisi & Skala</h3>

    <label>Posisi X</label>
    <div class="row">
        <button class="step" data-target="posX" data-step="-1">âˆ’</button>
        <input type="range" id="posX" min="-500" max="500" value="0">
        <button class="step" data-target="posX" data-step="1">+</button>
    </div>

    <label>Posisi Y</label>
    <div class="row">
        <button class="step" data-target="posY" data-step="-1">âˆ’</button>
        <input type="range" id="posY" min="-500" max="500" value="0">
        <button class="step" data-target="posY" data-step="1">+</button>
    </div>

    <label>Skala</label>
    <div class="row">
        <button class="step" data-target="scale" data-step="-0.02">âˆ’</button>
        <input type="range" id="scale" min="0.1" max="3" step="0.01" value="1">
        <button class="step" data-target="scale" data-step="0.02">+</button>
    </div>

    <label>Rotasi</label>
    <div class="row">
        <button class="step" data-target="rotation" data-step="-1">âˆ’</button>
        <input type="range" id="rotation" min="-180" max="180" value="0">
        <button class="step" data-target="rotation" data-step="1">+</button>
    </div>

    <label>Opacity Motif</label>
    <div class="row">
        <button class="step" data-target="opacity" data-step="-0.02">âˆ’</button>
        <input type="range" id="opacity" min="0" max="1" step="0.01" value="1">
        <button class="step" data-target="opacity" data-step="0.02">+</button>
    </div>

    <label>Displacement Strength</label>
    <div class="row">
        <button class="step" data-target="disp" data-step="-0.01">âˆ’</button>
        <input type="range" id="disp" min="0" max="1" step="0.01" value="0.25">
        <button class="step" data-target="disp" data-step="0.01">+</button>
    </div>

    <hr>

    <h3>ðŸ§½ AI Brush (Mode 3 â€“ Fully Intelligent)</h3>

    <div class="badge">AI Brush aktif â†’ otomatis menempel edge / membedakan kain vs motif.</div>

    <label>Ukuran Brush</label>
    <div class="row">
        <button class="step" data-target="brushSize" data-step="-2">âˆ’</button>
        <input type="range" id="brushSize" min="5" max="120" value="40">
        <button class="step" data-target="brushSize" data-step="2">+</button>
    </div>

    <label>Feather</label>
    <div class="row">
        <button class="step" data-target="brushFeather" data-step="-1">âˆ’</button>
        <input type="range" id="brushFeather" min="0" max="30" value="10">
        <button class="step" data-target="brushFeather" data-step="1">+</button>
    </div>

    <div class="controls-grid">
        <button id="enableBrush" class="accent">Aktifkan Eraser</button>
        <button id="disableBrush" class="neutral">Matikan Eraser</button>
    </div>

    <div class="controls-grid">
        <button id="undoBtn" class="danger">Undo</button>
        <button id="resetEraser" class="neutral">Reset Eraser</button>
    </div>

    <hr>

    <button id="saveBtn" style="width:100%;margin-top:12px;">Download Hasil</button>
</div>

<!-- PREVIEW AREA -->
<div class="preview-wrap">
    <div class="preview">
        <canvas id="mainCanvas" width="900" height="1100"></canvas>
    </div>

    <div class="thumbs">
        <img id="shirtThumb" src="">
        <img id="patternThumb" src="">
        <img id="maskThumb" src="">
    </div>
</div>

<div id="mtIndicator" class="mt-indicator">Zoom mode</div>
<!-- PART 2 / 5 END -->
<!-- PART 3 / 5 START -->
<script>
// =========================
// GLOBAL VARIABLES & CANVAS
// =========================
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');

let shirtImg = new Image();
let patternImg = new Image();
let maskImg = new Image();

let patternReady = false;
let shirtReady = false;
let maskReady = false;

// Canvas temp untuk displacement & masking
const dispCanvas = document.createElement('canvas');
const dispCtx = dispCanvas.getContext('2d');

const maskCanvas = document.createElement('canvas');
const maskCtx = maskCanvas.getContext('2d');

const eraseCanvas = document.createElement('canvas');  // eraser mask
const eraseCtx = eraseCanvas.getContext('2d');

// Undo stack untuk eraser AI
let undoStack = [];
const MAX_UNDO = 15;

// =========================
// TUNING STATE
// =========================
let state = {
    posX: 0,
    posY: 0,
    scale: 1,
    rotation: 0,
    opacity: 1,
    dispStrength: 0.25,
    brushSize: 40,
    brushFeather: 10,
    brushEnabled: false
};

// =========================
// FILE INPUT HANDLING
// =========================
function loadImageFromInput(input, imgObj, onReady) {
    const file = input.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    imgObj.onload = () => {
        onReady();
        render();
    };
    imgObj.src = url;
}

shirtInput.addEventListener('change', () => {
    loadImageFromInput(shirtInput, shirtImg, () => {
        shirtReady = true;
        shirtThumb.src = shirtImg.src;
    });
});

patternInput.addEventListener('change', () => {
    loadImageFromInput(patternInput, patternImg, () => {
        patternReady = true;
        patternThumb.src = patternImg.src;
    });
});

maskInput.addEventListener('change', () => {
    loadImageFromInput(maskInput, maskImg, () => {
        maskReady = true;
        maskThumb.src = maskImg.src;

        maskCanvas.width = canvas.width;
        maskCanvas.height = canvas.height;

        // render mask ke maskCanvas
        maskCtx.clearRect(0, 0, maskCanvas.width, maskCanvas.height);
        maskCtx.drawImage(maskImg, 0, 0, maskCanvas.width, maskCanvas.height);
    });
});

// =========================
// RENDER UTAMA
// =========================
function render() {
    if (!shirtReady || !maskReady) {
        ctx.fillStyle = "#ddd";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        return;
    }

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // 1. Gambar baju dasar
    ctx.drawImage(shirtImg, 0, 0, canvas.width, canvas.height);

    if (patternReady) {
        const w = patternImg.width * state.scale;
        const h = patternImg.height * state.scale;

        dispCanvas.width = w;
        dispCanvas.height = h;
        dispCtx.clearRect(0, 0, w, h);

        // 2. Draw motif ke dispCanvas
        dispCtx.save();
        dispCtx.globalAlpha = state.opacity;

        dispCtx.translate(w / 2, h / 2);
        dispCtx.rotate(state.rotation * Math.PI / 180);
        dispCtx.translate(-w / 2, -h / 2);

        dispCtx.drawImage(patternImg, 0, 0, w, h);
        dispCtx.restore();

        // 3. Apply displacement
        applyDisplacement(dispCanvas, dispCtx, maskCanvas, state.dispStrength);

        // 4. Masking: hanya bagian dalam baju
        ctx.save();
        ctx.globalCompositeOperation = "source-over";
        ctx.drawImage(dispCanvas, state.posX + canvas.width/2 - w/2, state.posY + canvas.height/2 - h/2);

        // 5. Terapkan eraser mask
        ctx.globalCompositeOperation = "destination-out";
        ctx.drawImage(eraseCanvas, 0, 0);
        ctx.restore();
    }
}

// =========================
// DISPLACEMENT MAPPING
// =========================
function applyDisplacement(srcCanvas, srcCtx, maskCanvas, strength) {
    const w = srcCanvas.width;
    const h = srcCanvas.height;

    const imgData = srcCtx.getImageData(0, 0, w, h);
    const maskData = maskCtx.getImageData(0, 0, maskCanvas.width, maskCanvas.height);

    const out = srcCtx.createImageData(w, h);

    for (let y = 0; y < h; y++) {
        for (let x = 0; x < w; x++) {

            const gx = Math.floor((x + state.posX + canvas.width/2 - w/2));
            const gy = Math.floor((y + state.posY + canvas.height/2 - h/2));

            if (gx < 0 || gx >= maskCanvas.width || gy < 0 || gy >= maskCanvas.height) continue;

            const mi = (gy * maskCanvas.width + gx) * 4;
            const alpha = maskData.data[mi + 3];

            if (alpha < 10) continue;

            const heightVal = maskData.data[mi]; // gunakan channel R
            const dx = (heightVal - 128) / 128 * strength * 4;
            const dy = (heightVal - 128) / 128 * strength * 4;

            let sx = Math.floor(x + dx);
            let sy = Math.floor(y + dy);

            sx = Math.max(0, Math.min(w - 1, sx));
            sy = Math.max(0, Math.min(h - 1, sy));

            const si = (sy * w + sx) * 4;
            const di = (y * w + x) * 4;

            out.data[di]     = imgData.data[si];
            out.data[di + 1] = imgData.data[si + 1];
            out.data[di + 2] = imgData.data[si + 2];
            out.data[di + 3] = imgData.data[si + 3];
        }
    }

    srcCtx.putImageData(out, 0, 0);
}

// =========================
// UPDATE TUNING SLIDERS
// =========================
function bindSlider(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('input', () => {
        state[key] = Number(el.value);
        render();
    });
}

bindSlider("posX", "posX");
bindSlider("posY", "posY");
bindSlider("scale", "scale");
bindSlider("rotation", "rotation");
bindSlider("opacity", "opacity");
bindSlider("disp", "dispStrength");
bindSlider("brushSize", "brushSize");
bindSlider("brushFeather", "brushFeather");

// +/- buttons
document.querySelectorAll(".step").forEach(btn => {
    btn.addEventListener("click", () => {
        const target = document.getElementById(btn.dataset.target);
        target.value = Number(target.value) + Number(btn.dataset.step);
        target.dispatchEvent(new Event("input"));
    });
});

// =========================
// ERASE CANVAS INIT
// =========================
eraseCanvas.width = canvas.width;
eraseCanvas.height = canvas.height;
eraseCtx.fillStyle = "rgba(0,0,0,0)";
eraseCtx.fillRect(0, 0, eraseCanvas.width, eraseCanvas.height);

// UNDO SYSTEM
function pushUndo() {
    if (undoStack.length > MAX_UNDO) undoStack.shift();
    undoStack.push(eraseCtx.getImageData(0, 0, eraseCanvas.width, eraseCanvas.height));
}

undoBtn.addEventListener("click", () => {
    if (undoStack.length > 0) {
        const last = undoStack.pop();
        eraseCtx.putImageData(last, 0, 0);
        render();
    }
});

resetEraser.addEventListener("click", () => {
    eraseCtx.clearRect(0, 0, eraseCanvas.width, eraseCanvas.height);
    render();
});

enableBrush.addEventListener("click", () => {
    state.brushEnabled = true;
});
disableBrush.addEventListener("click", () => {
    state.brushEnabled = false;
});
</script>
<!-- PART 3 / 5 END -->
<!-- PART 4 / 5 START -->
<script>
// ======================================================
// AI BRUSH (MODE 3 â€” FULL INTELLIGENT MASKING)
// ======================================================

// --------------------
// Utility: ambil pixel
// --------------------
function getPixel(imgData, x, y) {
    const w = imgData.width;
    const i = (y * w + x) * 4;
    return [
        imgData.data[i],
        imgData.data[i+1],
        imgData.data[i+2],
        imgData.data[i+3]
    ];
}

// ------------------------------------------
// Compute luminance / grayscale untuk analisis
// ------------------------------------------
function luminance(r,g,b) {
    return 0.299*r + 0.587*g + 0.114*b;
}

// ------------------------------------------------------
// K-MEANS 2 CLUSTER untuk area sekitar pointer
// ------------------------------------------------------
function kmeansCluster(pixels) {
    if (pixels.length < 2) return [0,0];

    // init centroid sederhana
    let c1 = pixels[0];
    let c2 = pixels[pixels.length-1];

    for (let iter=0; iter<3; iter++) {
        let g1 = [], g2 = [];

        pixels.forEach(p => {
            const d1 = Math.abs(p - c1);
            const d2 = Math.abs(p - c2);
            if (d1 < d2) g1.push(p);
            else g2.push(p);
        });

        if (g1.length) c1 = g1.reduce((a,b)=>a+b)/g1.length;
        if (g2.length) c2 = g2.reduce((a,b)=>a+b)/g2.length;
    }

    return [c1, c2];
}

// ------------------------------------------------------
// PILIH cluster mana yang akan DIHAPUS
// Logika auto: motif vs kain vs lubang kerah
// ------------------------------------------------------
function chooseClusterToErase(cluster1, cluster2, centerLum) {
    const d1 = Math.abs(cluster1 - centerLum);
    const d2 = Math.abs(cluster2 - centerLum);

    // cluster dengan perbedaan terbesar â†’ dianggap "bukan kain"
    return (d1 > d2) ? cluster1 : cluster2;
}

// ------------------------------------------------------
// AI BRUSH CORE
// ------------------------------------------------------
let pointerDown = false;
let activeTouches = 0;

canvas.addEventListener("pointerdown", e => {
    activeTouches++;
    if (activeTouches > 1) return; // multi-touch = disable brush

    pointerDown = true;
    if (!state.brushEnabled) return;

    pushUndo();
    aiBrushStroke(e);
});

canvas.addEventListener("pointermove", e => {
    if (!pointerDown) return;
    if (!state.brushEnabled) return;
    if (activeTouches > 1) return;

    aiBrushStroke(e);
});

canvas.addEventListener("pointerup", () => {
    pointerDown = false;
    activeTouches = Math.max(0, activeTouches - 1);
});

canvas.addEventListener("pointercancel", () => {
    pointerDown = false;
    activeTouches = 0;
});

// --------------------------------------------------
// AI Brush Stroke
// --------------------------------------------------
function aiBrushStroke(e) {
    const rect = canvas.getBoundingClientRect();
    const x = Math.floor((e.clientX - rect.left) / rect.width * canvas.width);
    const y = Math.floor((e.clientY - rect.top) / rect.height * canvas.height);

    const bs = state.brushSize;
    const rad = Math.floor(bs / 2);

    // Ambil data canvas utama (shirt + motif)
    const mainData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // Ambil pixel sekitar pointer untuk clustering
    let samples = [];
    for (let dy = -rad; dy <= rad; dy+=4) {
        for (let dx = -rad; dx <= rad; dx+=4) {
            const px = x + dx;
            const py = y + dy;
            if (px < 0 || py < 0 || px >= canvas.width || py >= canvas.height) continue;

            const [r,g,b,a] = getPixel(mainData, px, py);
            if (a < 10) continue;

            samples.push(luminance(r,g,b));
        }
    }

    if (samples.length < 2) return;

    // Jalankan k-means
    const [c1, c2] = kmeansCluster(samples);

    // Luminance tengah
    const [cr,cg,cb,ca] = getPixel(mainData, x, y);
    const centerLum = luminance(cr,cg,cb);

    // Tentukan cluster mana yang harus dihapus
    const targetCluster = chooseClusterToErase(c1, c2, centerLum);

    // Render hapusan ke eraseCanvas
    const eraseData = eraseCtx.getImageData(0, 0, eraseCanvas.width, eraseCanvas.height);
    const feather = state.brushFeather;

    for (let dy = -rad; dy <= rad; dy++) {
        for (let dx = -rad; dx <= rad; dx++) {
            const px = x + dx;
            const py = y + dy;
            if (px < 0 || py < 0 || px >= canvas.width || py >= canvas.height) continue;

            const [r,g,b,a] = getPixel(mainData, px, py);
            if (a < 10) continue;

            const lum = luminance(r,g,b);

            // pixel ini termasuk cluster target?
            if (Math.abs(lum - targetCluster) < 12) {

                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist > rad) continue;

                const t = Math.max(0, (rad - dist) / feather);
                const alpha = Math.min(255, Math.floor(t * 255));

                const i = (py * canvas.width + px) * 4;
                eraseData.data[i+3] = Math.max(eraseData.data[i+3], alpha);
            }
        }
    }

    eraseCtx.putImageData(eraseData, 0, 0);
    render();
}
</script>
<!-- PART 4 / 5 END -->
<!-- PART 5 / 5 START -->
<script>
// ================================
// DOWNLOAD HASIL
// ================================
saveBtn.addEventListener("click", () => {
    const link = document.createElement("a");
    link.download = "mockup_result.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
});

// ================================
// PINCH ZOOM INDICATOR
// ================================
let mtShowing = false;
function showMT() {
    if (mtShowing) return;
    mtShowing = true;
    const el = document.getElementById("mtIndicator");
    el.style.opacity = 1;
    setTimeout(() => {
        el.style.opacity = 0;
        mtShowing = false;
    }, 700);
}

canvas.addEventListener("touchmove", e => {
    if (e.touches.length > 1) {
        showMT();
    }
});

// ================================
// RENDER AWAL
// ================================
render();
</script>

</body>
</html>
<!-- PART 5 / 5 END -->
